---
- name: Quick Kubernetes setup with proven tools
  hosts: k8s_master
  become: yes

  tasks:
    - name: Install k3s with external IP
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--tls-san 158.160.113.176" sh -
      args:
        creates: /etc/rancher/k3s/k3s.yaml

    - name: Wait for k3s to be ready
      command: /usr/local/bin/k3s kubectl get nodes
      register: k3s_status
      until: k3s_status.rc == 0
      retries: 10
      delay: 10

    - name: Setup kubeconfig for user
      block:
        - name: Create .kube directory
          file:
            path: /home/ubuntu/.kube
            state: directory
            owner: ubuntu
            group: ubuntu

        - name: Copy kubeconfig
          copy:
            src: /etc/rancher/k3s/k3s.yaml
            dest: /home/ubuntu/.kube/config
            remote_src: yes
            owner: ubuntu
            group: ubuntu

        - name: Fix kubeconfig server address
          replace:
            path: /home/ubuntu/.kube/config
            regexp: '127.0.0.1'
            replace: '158.160.113.176'

    - name: Check cluster status
      command: kubectl get nodes
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      register: cluster_status

    - name: Show cluster status
      debug:
        var: cluster_status.stdout
